name: Nim Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  test-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        nim-version: ['binary:2.0.0', 'binary:stable']
    steps:
    - uses: actions/checkout@v4

    - name: Setup Nim
      uses: iffy/install-nim@v5
      with:
        version: ${{ matrix.nim-version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Dependencies
      run: nimble install -y

    - name: Run Tests
      run: nimble test

    - name: Run Tests with ARC
      run: nimble test --mm:arc -y

    - name: Build Example
      run: nim cpp --path:. -o:example/undsrc example/undsrc.nim

    - name: Test Example
      run: |
        ./example/undsrc tests/data/test.fastq.dsrc > /tmp/out.fq
        test $(wc -l < /tmp/out.fq) -eq 16

  benchmark:
    if: github.event_name == 'push'
    needs: test-linux
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Setup Nim
      uses: iffy/install-nim@v5
      with:
        version: 'binary:2.2.4'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Dependencies
      run: nimble install -y

    - name: Install hyperfine
      run: |
        wget -q https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
        sudo dpkg -i hyperfine_1.18.0_amd64.deb

    - name: Install dsrc
      run: |
        wget -q https://github.com/refresh-bio/DSRC/releases/download/v2.0.2/dsrc-linux-x64-static.tar.gz
        tar xzf dsrc-linux-x64-static.tar.gz
        sudo mv bin/dsrc /usr/local/bin/

    - name: Run Benchmarks
      run: make bench

    - name: Generate Summary
      run: python3 benchmark/bench_summary.py > benchmark/bench_summary.txt

    - name: Commit Benchmark Results
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add benchmark/
        git diff --cached --quiet || git commit -m "Update benchmark results [skip ci]"
        git push

  test-macos:
    if: github.event_name == 'release'
    runs-on: macos-latest
    strategy:
      matrix:
        nim-version: ['binary:stable']
    steps:
    - uses: actions/checkout@v4

    - name: Setup Nim
      uses: iffy/install-nim@v5
      with:
        version: ${{ matrix.nim-version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Dependencies
      run: nimble install -y

    - name: Run Tests
      run: nimble test

    - name: Run Tests with ARC
      run: nimble test --mm:arc -y

    - name: Build Example
      run: nim cpp --path:. -o:example/undsrc example/undsrc.nim

    - name: Test Example
      run: |
        ./example/undsrc tests/data/test.fastq.dsrc > /tmp/out.fq
        test $(wc -l < /tmp/out.fq) -eq 16
