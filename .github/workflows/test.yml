name: Nim Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  test-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        nim-version: ['binary:2.0.0', 'binary:stable']
    steps:
    - uses: actions/checkout@v4

    - name: Setup Nim
      uses: iffy/install-nim@v5
      with:
        version: ${{ matrix.nim-version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Dependencies
      run: nimble install -y

    - name: Run Tests
      run: nimble test

    - name: Run Tests with ARC
      run: nimble test --mm:arc -y

    - name: Build Example
      run: nim cpp --path:. -o:example/undsrc example/undsrc.nim

    - name: Test Example
      run: |
        ./example/undsrc tests/data/test.fastq.dsrc > /tmp/out.fq
        test $(wc -l < /tmp/out.fq) -eq 16

  test-macos:
    if: github.event_name == 'release'
    runs-on: macos-latest
    strategy:
      matrix:
        nim-version: ['binary:stable']
    steps:
    - uses: actions/checkout@v4

    - name: Setup Nim
      uses: iffy/install-nim@v5
      with:
        version: ${{ matrix.nim-version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Dependencies
      run: nimble install -y

    - name: Run Tests
      run: nimble test

    - name: Run Tests with ARC
      run: nimble test --mm:arc -y

    - name: Build Example
      run: nim cpp --path:. -o:example/undsrc example/undsrc.nim

    - name: Test Example
      run: |
        ./example/undsrc tests/data/test.fastq.dsrc > /tmp/out.fq
        test $(wc -l < /tmp/out.fq) -eq 16
